// Authentication Functions
async function signUp() {
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        updateAuthStatus(`Signed up successfully! User: ${user.email}`, 'success');
        
        // Clear form
        document.getElementById('signup-email').value = '';
        document.getElementById('signup-password').value = '';
    } catch (error) {
        updateAuthStatus(`Sign up error: ${error.message}`, 'error');
    }
}

async function signIn() {
    const email = document.getElementById('signin-email').value;
    const password = document.getElementById('signin-password').value;

    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        updateAuthStatus(`Signed in as: ${user.email}`, 'success');
        
        // Clear form
        document.getElementById('signin-email').value = '';
        document.getElementById('signin-password').value = '';
    } catch (error) {
        updateAuthStatus(`Sign in error: ${error.message}`, 'error');
    }
}

async function signOut() {
    try {
        await auth.signOut();
        updateAuthStatus('Signed out successfully', 'success');
    } catch (error) {
        updateAuthStatus(`Sign out error: ${error.message}`, 'error');
    }
}

function updateAuthStatus(message, type) {
    const authStatus = document.getElementById('auth-status');
    authStatus.textContent = message;
    authStatus.className = type;
}

// Database Functions
async function addItem() {
    if (!auth.currentUser) {
        alert('Please sign in first');
        return;
    }

    const name = document.getElementById('item-name').value;
    const description = document.getElementById('item-description').value;

    if (!name || !description) {
        alert('Please fill in all fields');
        return;
    }

    try {
        await db.collection('items').add({
            name: name,
            description: description,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            userId: auth.currentUser.uid
        });

        // Clear form
        document.getElementById('item-name').value = '';
        document.getElementById('item-description').value = '';
        
        loadItems();
    } catch (error) {
        console.error('Error adding item:', error);
    }
}

async function loadItems() {
    try {
        const itemsSnapshot = await db.collection('items')
            .orderBy('createdAt', 'desc')
            .get();
        
        const itemsList = document.getElementById('items-list');
        itemsList.innerHTML = '';

        itemsSnapshot.forEach(doc => {
            const item = doc.data();
            const itemElement = document.createElement('div');
            itemElement.className = 'item';
            itemElement.innerHTML = `
                <h4>${item.name}</h4>
                <p>${item.description}</p>
                <small>Created by: ${item.userId}</small>
                <button class="delete-btn" onclick="deleteItem('${doc.id}')">Delete</button>
            `;
            itemsList.appendChild(itemElement);
        });
    } catch (error) {
        console.error('Error loading items:', error);
    }
}

async function deleteItem(itemId) {
    if (!auth.currentUser) {
        alert('Please sign in first');
        return;
    }

    try {
        await db.collection('items').doc(itemId).delete();
        loadItems();
    } catch (error) {
        console.error('Error deleting item:', error);
    }
}

// Storage Functions
async function uploadFile() {
    if (!auth.currentUser) {
        alert('Please sign in first');
        return;
    }

    const fileInput = document.getElementById('file-upload');
    const file = fileInput.files[0];

    if (!file) {
        alert('Please select a file');
        return;
    }

    try {
        const storageRef = storage.ref();
        const fileRef = storageRef.child(`files/${auth.currentUser.uid}/${file.name}`);
        
        const snapshot = await fileRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();
        
        // Save file info to Firestore
        await db.collection('files').add({
            name: file.name,
            url: downloadURL,
            uploadedBy: auth.currentUser.uid,
            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        fileInput.value = '';
        loadFiles();
    } catch (error) {
        console.error('Error uploading file:', error);
    }
}

async function loadFiles() {
    try {
        const filesSnapshot = await db.collection('files')
            .orderBy('uploadedAt', 'desc')
            .get();
        
        const filesList = document.getElementById('uploaded-files');
        filesList.innerHTML = '';

        filesSnapshot.forEach(doc => {
            const file = doc.data();
            const fileElement = document.createElement('div');
            fileElement.className = 'file-item';
            fileElement.innerHTML = `
                <h4>${file.name}</h4>
                <a href="${file.url}" target="_blank">Download</a>
                <small>Uploaded by: ${file.uploadedBy}</small>
            `;
            filesList.appendChild(fileElement);
        });
    } catch (error) {
        console.error('Error loading files:', error);
    }
}

// Auth State Listener
auth.onAuthStateChanged((user) => {
    if (user) {
        updateAuthStatus(`Logged in as: ${user.email}`, 'success');
        loadItems();
        loadFiles();
    } else {
        updateAuthStatus('Not logged in', 'error');
        document.getElementById('items-list').innerHTML = '';
        document.getElementById('uploaded-files').innerHTML = '';
    }
});

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    loadItems();
    loadFiles();
});
