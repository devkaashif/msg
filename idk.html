<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Territory Painter — Multiplayer (Firebase)</title>
  <style>
    :root{--bg:#0f1724;--grid:#111827;--ui:#e6edf3}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ui);font-family:Inter,system-ui,Arial}
    .wrap{display:flex;gap:16px;padding:18px}
    canvas{background:linear-gradient(180deg,#07102633,#00000066);border-radius:8px}
    .panel{width:320px}
    h1{margin:0 0 8px;font-size:18px}
    label{display:block;margin-top:8px;font-size:13px;color:#9fb0c6}
    input,button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:0}
    input{background:#0b1220;color:var(--ui)}
    button{background:#0ea5a4;color:#001;cursor:pointer}
    .info{margin-top:10px;font-size:13px;color:#9fb0c6}
    .players{margin-top:10px}
    .player-item{display:flex;align-items:center;gap:8px;margin:6px 0}
    .swatch{width:18px;height:18px;border-radius:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="800" height="520"></canvas>
    <div class="panel">
      <h1>Territory Painter — Multiplayer</h1>
      <div>
        <label>Display name</label>
        <input id="name" placeholder="Your name" />
        <label>Color (hex)</label>
        <input id="color" placeholder="#ff6b6b" />
        <button id="join">Join Game</button>
        <div class="info">Move with arrow keys or WASD. Move over tiles to claim them. Cover the grid to score.</div>
      </div>

      <div class="players">
        <h3 style="margin-top:14px">Players</h3>
        <div id="playersList"></div>
        <div style="margin-top:10px" id="scoreInfo"></div>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs (using compat for simpler migration) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  // ---------- Replace with provided config (already inserted) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDrHe4VwIFCyUI4u8-WwbcncSppJqf7AW4",
    authDomain: "new-1-15bbf.firebaseapp.com",
    projectId: "new-1-15bbf",
    storageBucket: "new-1-15bbf.firebasestorage.app",
    messagingSenderId: "25831911925",
    appId: "1:25831911925:web:bf664020e248a5f239f0bc",
    measurementId: "G-KY3MJVJ0EM"
  };
  // --------------------------------------------------------------------

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Game settings
  const COLS = 20; // width in tiles
  const ROWS = 13; // height in tiles
  const TILE = 32; // pixels

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // Resize canvas to grid size (plus padding)
  canvas.width = COLS * TILE + 2;
  canvas.height = ROWS * TILE + 2;

  // Local client state
  let client = {
    id: null,
    name: '',
    color: '#ff6b6b',
    x: 0,
    y: 0
  };

  // Firestore references
  const playersRef = db.collection('players');
  const tilesDoc = db.collection('game').doc('tiles');

  // UI elements
  const nameInput = document.getElementById('name');
  const colorInput = document.getElementById('color');
  const joinBtn = document.getElementById('join');
  const playersList = document.getElementById('playersList');
  const scoreInfo = document.getElementById('scoreInfo');

  // Local copy of world state
  let players = {};
  let tiles = {}; // map of "x_y" -> {ownerId, color}

  // Utility
  function randId(len=8){return Math.random().toString(36).slice(2,2+len)}
  function clamp(v,a,b){return Math.max(a,Math.min(b,v))}

  // Initialize tiles document if missing (small grid => ok)
  async function ensureTilesDoc(){
    const snap = await tilesDoc.get();
    if(!snap.exists){
      const map = {};
      for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++)map[`${x}_${y}`] = null;
      await tilesDoc.set({map});
    }
  }

  // Join the game
  joinBtn.addEventListener('click', async ()=>{
    client.name = (nameInput.value || 'Player_'+randId(3)).slice(0,18);
    client.color = (colorInput.value || '#'+Math.floor(Math.random()*16777215).toString(16)).slice(0,7);
    client.id = 'p_'+randId(6);
    client.x = Math.floor(Math.random()*COLS);
    client.y = Math.floor(Math.random()*ROWS);

    await ensureTilesDoc();

    // create player doc (no auth) with TTL-style heartbeat
    await playersRef.doc(client.id).set({
      name: client.name,
      color: client.color,
      x: client.x,
      y: client.y,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Claim starting tile
    claimTile(client.x, client.y);

    startRealtime();
    joinBtn.disabled = true;
  });

  // Movement handling
  window.addEventListener('keydown', (e)=>{
    if(!client.id) return;
    const key = e.key;
    let dx=0, dy=0;
    if(key==='ArrowUp' || key==='w' || key==='W') dy=-1;
    if(key==='ArrowDown' || key==='s' || key==='S') dy=1;
    if(key==='ArrowLeft' || key==='a' || key==='A') dx=-1;
    if(key==='ArrowRight' || key==='d' || key==='D') dx=1;
    if(dx||dy){
      client.x = clamp(client.x+dx,0,COLS-1);
      client.y = clamp(client.y+dy,0,ROWS-1);
      // update our player position and claim tile
      playersRef.doc(client.id).update({x:client.x,y:client.y,ts: firebase.firestore.FieldValue.serverTimestamp()});
      claimTile(client.x, client.y);
    }
  });

  // Claim a tile using a transaction (avoid race conditions)
  async function claimTile(x,y){
    const key = `${x}_${y}`;
    try{
      await db.runTransaction(async (tx)=>{
        const doc = await tx.get(tilesDoc);
        const map = doc.exists ? doc.data().map : {};
        // write owner to the tile
        map[key] = {ownerId: client.id, color: client.color, ts: Date.now()};
        tx.set(tilesDoc, {map});
      });
    }catch(err){
      console.warn('claim failed',err);
    }
  }

  // Real-time listeners
  function startRealtime(){
    // players list
    playersRef.onSnapshot(snapshot=>{
      players = {};
      snapshot.forEach(d=>{
        const data = d.data();
        // ignore stale players (no TTL here, but client removes on unload)
        players[d.id] = {...data};
      });
      renderPlayersList();
      render();
    });

    // tiles
    tilesDoc.onSnapshot(doc=>{
      const data = doc.data();
      tiles = data && data.map ? data.map : {};
      render();
      renderScoreInfo();
    });

    // heartbeat to update timestamp every 8 seconds
    setInterval(()=>{
      if(client.id) playersRef.doc(client.id).update({ts: firebase.firestore.FieldValue.serverTimestamp()}).catch(()=>{});
    },8000);

    // remove player on close
    window.addEventListener('beforeunload', ()=>{
      if(client.id) playersRef.doc(client.id).delete();
    });
  }

  // Drawing functions
  function render(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // draw tiles
    for(let y=0;y<ROWS;y++){
      for(let x=0;x<COLS;x++){
        const key = `${x}_${y}`;
        const t = tiles[key];
        if(t && t.color){
          ctx.fillStyle = t.color + 'cc'; // semi-transparent
          ctx.fillRect(1 + x*TILE, 1 + y*TILE, TILE-2, TILE-2);
        }else{
          ctx.fillStyle = '#0b1220';
          ctx.fillRect(1 + x*TILE, 1 + y*TILE, TILE-2, TILE-2);
        }
        // small grid lines
        ctx.strokeStyle = '#07182655';
        ctx.strokeRect(1 + x*TILE, 1 + y*TILE, TILE-2, TILE-2);
      }
    }

    // draw players
    Object.keys(players).forEach(pid=>{
      const p = players[pid];
      if(!p) return;
      const px = 1 + p.x * TILE + TILE/2;
      const py = 1 + p.y * TILE + TILE/2;
      ctx.beginPath();
      ctx.fillStyle = p.color || '#fff';
      ctx.arc(px, py, TILE*0.36, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = '#0008';
      ctx.stroke();
      // name
      ctx.fillStyle = '#eaf6ff';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(p.name || pid, px, py + TILE*0.7);
    });
  }

  function renderPlayersList(){
    playersList.innerHTML = '';
    Object.keys(players).forEach(pid=>{
      const p = players[pid];
      const div = document.createElement('div');
      div.className = 'player-item';
      div.innerHTML = `<div class=swatch style="background:${p.color}"></div><div style="flex:1">${p.name || pid}</div><div style="opacity:.8">${p.x},${p.y}</div>`;
      playersList.appendChild(div);
    });
  }

  function renderScoreInfo(){
    // count tiles per player
    const counts = {};
    Object.values(tiles).forEach(t=>{
      if(!t || !t.ownerId) return;
      counts[t.ownerId] = (counts[t.ownerId]||0) + 1;
    });
    // make a small leaderboard
    const items = Object.keys(counts).map(id=>({id,count:counts[id],name:players[id] ? players[id].name : id, color: (players[id] ? players[id].color : '#888')}));
    items.sort((a,b)=>b.count-a.count);
    scoreInfo.innerHTML = '<strong>Top coverage</strong><br>' + items.slice(0,5).map(it=>`<div style="display:flex;align-items:center;gap:8px;margin-top:6px"><div style="width:12px;height:12px;border-radius:3px;background:${it.color}"></div><div style="flex:1">${it.name}</div><div>${it.count}</div></div>`).join('');
  }

  // initial render
  render();

  </script>
</body>
</html>
