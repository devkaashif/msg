<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multiplayer Arena (Firestore)</title>
  <style>
    html,body { height:100%; margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:#111; color:#eaeaea; display:flex; flex-direction:column; align-items:center; }
    #topbar { width:100%; max-width:980px; display:flex; justify-content:space-between; align-items:center; padding:12px; box-sizing:border-box; }
    #status { font-size:14px; opacity:0.9; }
    #canvasWrap { width:100%; max-width:980px; background:#0d0d0d; border-radius:8px; padding:10px; box-sizing:border-box; }
    canvas { display:block; width:100%; height:600px; background:linear-gradient(#0b1220,#091018); border-radius:6px; }
    #controls { margin-top:8px; display:flex; gap:8px; align-items:center; }
    button { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; background:#1f6feb; color:#fff; }
    input,select { padding:8px; border-radius:6px; border:1px solid #333; background:#0f1724; color:#fff; }
    small { color:#bbb; }
  </style>
</head>
<body>
  <div id="topbar">
    <div>
      <strong>Multiplayer Arena</strong>
      <div id="status"><small>Connecting to Firebase...</small></div>
    </div>
    <div id="controls">
      <input id="nameInput" placeholder="name (optional)" />
      <select id="speedSelect" title="Movement speed">
        <option value="2">Slow</option>
        <option value="3" selected>Normal</option>
        <option value="5">Fast</option>
      </select>
      <button id="respawnBtn">Respawn</button>
    </div>
  </div>

  <div id="canvasWrap">
    <canvas id="arena" width="980" height="600"></canvas>
  </div>

  <script type="module">
    // -----------------------
    // Your Firebase config
    // -----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyD0T-mS__FlN3QASJnmD0K6S5VNDiN2bxQ",
      authDomain: "poplol-7209f.firebaseapp.com",
      projectId: "poplol-7209f",
      storageBucket: "poplol-7209f.firebasestorage.app",
      messagingSenderId: "1058108342269",
      appId: "1:1058108342269:web:577700a7503b3db8316394",
      measurementId: "G-EXR6CPBH5R"
    };

    // -----------------------
    // Firebase SDK (modular)
    // -----------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, deleteDoc, onSnapshot,
      collection, serverTimestamp, updateDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // -----------------------
    // Local player setup
    // -----------------------
    const canvas = document.getElementById('arena');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    const nameInput = document.getElementById('nameInput');
    const speedSelect = document.getElementById('speedSelect');
    const respawnBtn = document.getElementById('respawnBtn');

    // Keep player id persistent within the browser session
    let playerId = localStorage.getItem('playerId') || null;
    if (!playerId) {
      playerId = 'p_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('playerId', playerId);
    }

    // Player state
    const local = {
      id: playerId,
      name: nameInput.value || ('Player_' + playerId.slice(-4)),
      color: '#' + Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,'0'),
      x: Math.random()*(canvas.width - 60) + 30,
      y: Math.random()*(canvas.height - 60) + 30,
      size: 14,
      vx: 0, vy: 0,
      lastUpdate: Date.now()
    };

    // Active players from Firestore
    const players = new Map();

    // Movement
    const keys = {};
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    // UI events
    nameInput.addEventListener('change', () => {
      local.name = nameInput.value.trim() || local.name;
      writePlayer(true);
    });
    respawnBtn.addEventListener('click', () => {
      local.x = Math.random()*(canvas.width - 60) + 30;
      local.y = Math.random()*(canvas.height - 60) + 30;
      writePlayer(true);
    });

    // -----------------------
    // Firestore helpers
    // -----------------------
    const playersCol = collection(db, 'players');

    // Write player document. Use setDoc for idempotent writes.
    let lastWrite = 0;
    async function writePlayer(force=false) {
      const now = Date.now();
      // throttle writes to ~10 per second
      if (!force && now - lastWrite < 100) return;
      lastWrite = now;
      try {
        const pdoc = doc(db, 'players', local.id);
        await setDoc(pdoc, {
          id: local.id,
          name: local.name,
          color: local.color,
          x: local.x,
          y: local.y,
          size: local.size,
          lastSeen: serverTimestamp()
        }, { merge: true });
      } catch (err) {
        console.error('writePlayer error', err);
      }
    }

    // Remove player doc on unload
    window.addEventListener('beforeunload', () => {
      try {
        // best-effort synchronous delete; Firestore delete is async so we call without await
        deleteDoc(doc(db, 'players', local.id));
      } catch (e) {
        // ignore
      }
    });

    // Clean-up routine: periodically remove stale players locally (others may still exist server-side)
    function cleanupStalePlayers() {
      const cutoff = Date.now() - 30_000; // 30s
      for (const [id, p] of players.entries()) {
        if (p._lastSeenRaw && p._lastSeenRaw < cutoff) players.delete(id);
      }
    }

    // -----------------------
    // Real-time subscription
    // -----------------------
    onSnapshot(playersCol, snapshot => {
      snapshot.docChanges().forEach(change => {
        const d = change.doc.data();
        const id = d.id;
        // store a raw timestamp number for stale detection
        const lastSeenRaw = d.lastSeen && d.lastSeen.toMillis ? d.lastSeen.toMillis() : Date.now();
        if (change.type === 'removed') {
          players.delete(id);
        } else {
          // update or add
          players.set(id, {
            id, name: d.name || ('P'+id.slice(-4)),
            color: d.color || '#888',
            x: d.x || 0, y: d.y || 0,
            size: d.size || 12,
            _lastSeenRaw: lastSeenRaw
          });
        }
      });

      // Update status
      statusEl.innerHTML = `<small>Connected. Players: ${players.size}</small>`;
    }, err => {
      console.error('onSnapshot error', err);
      statusEl.innerHTML = `<small style="color:salmon">Realtime error</small>`;
    });

    // -----------------------
    // Game loop
    // -----------------------
    const now = () => Date.now();
    let lastFrame = now();

    function gameStep() {
      const t = now();
      const dt = (t - lastFrame) / 1000;
      lastFrame = t;

      // update local velocity from keys
      const speed = Number(speedSelect.value) || 3;
      let dx = 0, dy = 0;
      if (keys['arrowup'] || keys['w']) dy -= 1;
      if (keys['arrowdown'] || keys['s']) dy += 1;
      if (keys['arrowleft'] || keys['a']) dx -= 1;
      if (keys['arrowright'] || keys['d']) dx += 1;
      // normalize
      if (dx !== 0 || dy !== 0) {
        const len = Math.hypot(dx, dy);
        dx = dx/len; dy = dy/len;
      }
      local.vx = dx * speed;
      local.vy = dy * speed;

      // apply movement
      local.x += local.vx;
      local.y += local.vy;
      // clamp to arena bounds
      local.x = Math.max(local.size + 4, Math.min(canvas.width - local.size - 4, local.x));
      local.y = Math.max(local.size + 4, Math.min(canvas.height - local.size - 4, local.y));

      // write to Firestore at a controlled rate
      writePlayer();

      // draw
      draw();

      // cleanup stale players every 5s
      if (Math.floor(t/5000) !== Math.floor((t - dt*1000)/5000)) cleanupStalePlayers();

      requestAnimationFrame(gameStep);
    }

    function draw() {
      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // draw others
      for (const [id, p] of players.entries()) {
        if (id === local.id) continue;
        drawPlayer(p, false);
      }

      // draw local (on top)
      drawPlayer(local, true);

      // draw HUD
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      ctx.fillRect(6,6,220,40);
      ctx.fillStyle = '#ddd';
      ctx.font = '14px system-ui';
      ctx.fillText(`${local.name} (${local.id.slice(-6)})`, 14, 24);
    }

    function drawPlayer(p, isLocal) {
      // p might be from Firestore or local
      const x = p.x, y = p.y, size = p.size || 12;
      ctx.beginPath();
      ctx.fillStyle = p.color || '#999';
      ctx.arc(x, y, size, 0, Math.PI*2);
      ctx.fill();
      // name tag
      ctx.font = (isLocal ? 'bold 13px system-ui' : '12px system-ui');
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.fillText(p.name || ('P'+p.id.slice(-4)), x - size, y - size - 8);
    }

    // start loop after ensuring initial write
    (async () => {
      // try to read existing doc if present
      try {
        const pdocRef = doc(db, 'players', local.id);
        const snapshot = await getDoc(pdocRef);
        if (snapshot.exists()) {
          // pick up previous color/name if found
          const d = snapshot.data();
          if (d.color) local.color = d.color;
          if (d.name) local.name = d.name;
        }
      } catch (e) {
        console.warn('initial doc read error', e);
      }

      nameInput.value = local.name;
      statusEl.innerHTML = `<small>Connected. ID ${local.id}</small>`;
      // write initial presence and start
      await writePlayer(true);

      // start the heartbeat to update lastSeen timestamp every 3s
      setInterval(() => writePlayer(true), 3000);

      requestAnimationFrame(gameStep);
    })();

    // Helpful dev function: clear all players (DO NOT call in production)
    window.__clearPlayers = async () => {
      const snapshot = await window.firebase && window.firebase.firestore ? null : null;
      // intentionally left blank: clearing requires admin or manually deleting docs in console
      console.info('To clear players, delete docs from Firebase console (collection "players").');
    };
  </script>
</body>
</html>
