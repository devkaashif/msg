<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2D Multiplayer â€” Firebase Firestore (single file)</title>
  <style>
    :root{--bg:#0f1724;--panel:#0b1220;--muted:#93a0b3}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial;background:var(--bg);color:#e6eef6}
    #wrap{display:flex;height:100vh;gap:16px;padding:16px;box-sizing:border-box}
    #game{flex:1;display:flex;flex-direction:column}
    canvas{background:linear-gradient(180deg,#071021, #0b1220);border-radius:8px;display:block;width:100%;height:100%}
    #hud{display:flex;gap:12px;margin-top:8px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:8px;min-width:200px}
    #playersList{max-height:50vh;overflow:auto;font-size:14px}
    .playerRow{display:flex;align-items:center;gap:8px;padding:6px 0}
    .dot{width:14px;height:14px;border-radius:50%}
    #instructions{color:var(--muted);font-size:13px;margin-top:8px}
    button{background:#1f6feb;border:none;color:white;padding:8px 10px;border-radius:6px;cursor:pointer}
    button.secondary{background:#3b4754}
  </style>
</head>
<body>
  <div id="wrap">
    <div id="game">
      <canvas id="c"></canvas>
      <div id="hud">
        <div class="panel" style="flex:0 0 260px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong id="meName">Player</strong>
              <div id="meId" style="font-size:12px;color:var(--muted)"></div>
            </div>
            <div>
              <button id="recenterBtn">Recenter</button>
            </div>
          </div>
          <div id="instructions">Move with WASD or arrow keys. Close the tab to leave. This demo uses Firestore and anonymous auth.</div>
        </div>
        <div class="panel" style="flex:0 0 220px">
          <div style="font-weight:600;margin-bottom:6px">Players</div>
          <div id="playersList"></div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="changeColorBtn">Change Color</button>
            <button class="secondary" id="respawnBtn">Respawn</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase compat libs (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
  // ----- Paste your firebaseConfig here (you already provided it) -----
  const firebaseConfig = {
    apiKey: "AIzaSyDrHe4VwIFCyUI4u8-WwbcncSppJqf7AW4",
    authDomain: "new-1-15bbf.firebaseapp.com",
    projectId: "new-1-15bbf",
    storageBucket: "new-1-15bbf.firebasestorage.app",
    messagingSenderId: "25831911925",
    appId: "1:25831911925:web:bf664020e248a5f239f0bc",
    measurementId: "G-KY3MJVJ0EM"
  };
  // -------------------------------------------------------------------

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Game state
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  let W = 800, H = 600;
  const playerSize = 28;

  // local player data
  let me = { id: null, name: null, x: 0, y: 0, color: null, alive: true };
  const players = new Map(); // id -> player

  // input
  const keys = {};
  window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
  window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

  // DOM
  const playersListEl = document.getElementById('playersList');
  const meNameEl = document.getElementById('meName');
  const meIdEl = document.getElementById('meId');
  document.getElementById('recenterBtn').onclick = () => centerOnMe();
  document.getElementById('changeColorBtn').onclick = () => {
    me.color = randomColor(); updateMyDoc();
  };
  document.getElementById('respawnBtn').onclick = () => {
    me.x = Math.random()*2000 - 1000; me.y = Math.random()*2000 - 1000; me.alive = true; updateMyDoc();
  }

  // helper
  function randomColor(){
    const hue = Math.floor(Math.random()*360);
    return `hsl(${hue} 80% 60%)`;
  }

  function resize(){
    const ratio = devicePixelRatio || 1;
    W = canvas.clientWidth = canvas.parentElement.clientWidth;
    H = canvas.clientHeight = Math.max(300, window.innerHeight - 220);
    canvas.width = Math.floor(W * ratio);
    canvas.height = Math.floor(H * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  // sign in anonymously, then create player doc
  auth.signInAnonymously().then(({user}) => {
    me.id = user.uid;
    me.name = 'P-' + me.id.slice(0,5);
    me.color = randomColor();
    me.x = Math.random()*2000 - 1000;
    me.y = Math.random()*2000 - 1000;
    me.alive = true;

    meNameEl.textContent = me.name;
    meIdEl.textContent = me.id;

    // create or overwrite our doc
    createMyDoc().then(() => {
      // listen for all players
      db.collection('players').onSnapshot(onPlayersSnapshot, err => console.error(err));
    });

    // remove doc when closing tab
    window.addEventListener('beforeunload', () => {
      db.collection('players').doc(me.id).delete().catch(()=>{});
    });

    startLoop();
  }).catch(err => {
    alert('Firebase auth failed: ' + err.message);
    console.error(err);
  });

  function createMyDoc(){
    return db.collection('players').doc(me.id).set({
      id: me.id,
      name: me.name,
      x: me.x,
      y: me.y,
      color: me.color,
      alive: me.alive,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  // update doc (throttled)
  let lastUpdate = 0;
  function updateMyDoc(){
    const now = performance.now();
    if(now - lastUpdate < 50) return; // ~20 updates/sec
    lastUpdate = now;
    db.collection('players').doc(me.id).set({
      id: me.id,
      name: me.name,
      x: me.x,
      y: me.y,
      color: me.color,
      alive: me.alive,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true}).catch(err=>console.error('update err',err));
  }

  function onPlayersSnapshot(snapshot){
    snapshot.docChanges().forEach(change => {
      const doc = change.doc.data();
      if(change.type === 'added' || change.type === 'modified'){
        players.set(doc.id, doc);
      } else if(change.type === 'removed'){
        players.delete(doc.id);
      }
    });
    renderPlayersList();
  }

  function renderPlayersList(){
    playersListEl.innerHTML = '';
    Array.from(players.values()).sort((a,b)=>a.name.localeCompare(b.name)).forEach(p => {
      const row = document.createElement('div'); row.className='playerRow';
      const dot = document.createElement('div'); dot.className='dot'; dot.style.background = p.color || '#888';
      const label = document.createElement('div'); label.textContent = p.name + (p.id===me.id? ' (you)':'');
      row.appendChild(dot); row.appendChild(label);
      playersListEl.appendChild(row);
    });
  }

  // camera
  let camX = 0, camY = 0;
  function centerOnMe(){ camX = me.x - W/2; camY = me.y - H/2; }

  // game loop
  let lastFrame = performance.now();
  function startLoop(){
    requestAnimationFrame(loop);
  }

  function loop(ts){
    const dt = Math.min(50, ts - lastFrame);
    lastFrame = ts;

    // update local player with input
    const speed = 0.28 * dt; // pixels per ms
    let dx = 0, dy = 0;
    if(keys['arrowup']||keys['w']) dy -= 1;
    if(keys['arrowdown']||keys['s']) dy += 1;
    if(keys['arrowleft']||keys['a']) dx -= 1;
    if(keys['arrowright']||keys['d']) dx += 1;
    if(dx!==0 || dy!==0){
      const len = Math.hypot(dx,dy) || 1;
      me.x += (dx/len) * speed * 60; // normalized and scaled to look smooth
      me.y += (dy/len) * speed * 60;
      updateMyDoc();
    }

    // simple idle auto-center following
    camX += (me.x - W/2 - camX) * 0.08;
    camY += (me.y - H/2 - camY) * 0.08;

    render();
    requestAnimationFrame(loop);
  }

  function render(){
    // clear
    ctx.clearRect(0,0,W,H);

    // draw grid
    const gridSize = 64;
    ctx.save();
    ctx.translate(-camX % gridSize, -camY % gridSize);
    ctx.globalAlpha = 0.08;
    for(let x=-gridSize;x<=W+gridSize;x+=gridSize){
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    }
    for(let y=-gridSize;y<=H+gridSize;y+=gridSize){
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }
    ctx.restore();
    ctx.globalAlpha = 1;

    // draw all players
    players.forEach(p => {
      drawPlayer(p);
    });

    // highlight me
    if(players.has(me.id)){
      const p = players.get(me.id);
      ctx.save();
      ctx.strokeStyle = '#fff'; ctx.lineWidth=2; ctx.globalAlpha=0.6;
      const sx = p.x - camX, sy = p.y - camY;
      ctx.beginPath(); ctx.ellipse(sx, sy, playerSize/1.6, playerSize/1.6, 0, 0, Math.PI*2); ctx.stroke();
      ctx.restore();
    }
  }

  function drawPlayer(p){
    const x = p.x - camX, y = p.y - camY;
    ctx.save();
    ctx.translate(x,y);
    // shadow
    ctx.globalAlpha = 0.12; ctx.beginPath(); ctx.ellipse(0, playerSize*0.6, playerSize*0.9, playerSize*0.4, 0, 0, Math.PI*2); ctx.fillStyle = '#000'; ctx.fill();
    ctx.globalAlpha = 1;
    // body
    ctx.beginPath(); ctx.fillStyle = p.color || '#888'; ctx.rect(-playerSize/2, -playerSize/2, playerSize, playerSize); ctx.fill();
    // name tag
    ctx.font = '12px system-ui, Arial'; ctx.textAlign='center'; ctx.fillStyle = '#fff'; ctx.fillText(p.name, 0, -playerSize);
    ctx.restore();
  }

  // listen to remote changes but keep our own local me consistent if we haven't yet created doc
  db.collection('players').onSnapshot(()=>{}, ()=>{}); // ensure listener remains active (we set proper listener after sign-in)

  // convenience: if user closes without delete, remove stale players older than 5 minutes (optional)
  // Note: this cleanup requires a server or Cloud Function for robust removal in production. For demo, we won't run cleanup here.

  // center on me initially when we know position
  function initialCenterWhenReady(){
    if(me.id){ centerOnMe(); } else setTimeout(initialCenterWhenReady,200);
  }
  initialCenterWhenReady();

  </script>

</body>
</html>
